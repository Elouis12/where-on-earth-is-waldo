<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Play | Where on Earth is Waldo?</title>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/play.css">
    <link rel="stylesheet" type="text/css" href="/css/players.css">
    <link rel="stylesheet" type="text/css" href="/css/toggle.css">
    <link rel="stylesheet" type="text/css" href="/css/playSettings.css">
    <link rel="stylesheet" type="text/css" href="/css/loader.css">
    <link rel="stylesheet" type="text/css" href="/css/nav.css">
    <link rel="stylesheet" type="text/css" href="/css/skeletonLoading.css">
    <link type="text/css" rel="stylesheet" href="/css/session.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!--  SCRIPT  -->
    <script src='https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.js'></script>

    <script type="module" src="../js/play.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script type="module">

        import { ClientHandler } from "./js/ClientHandler.js";
        import {displayNameInput, joinSession, validID, updateNav} from "./js/JoinSession.js";


        let sessionID = window.location.href.split("=")[1];

        await validID(sessionID);

        await updateNav();

        // document.getElementById("session-id-h1").innerText = sessionID;

        // remove username if exit tab
        // later use disconnect event for socket to grab the username set to the socket
        // send it to all socket, grab the ssionID from one of the sockets, have another event that sned sit back to server an and remove useranae for that session
        window.addEventListener('beforeunload', ()=>{

            localStorage.removeItem('session-name');
            localStorage.removeItem("game-options");

        });
        // check if user is logged in
        let userInfo = await fetch(

            "/auth/user-info",
            {
                method: 'POST',
                headers : {

                    'Content-type' : 'application/json'
                },
                body : JSON.stringify({
                    refreshToken: localStorage.getItem("refreshToken")
                })
            }
        ).then(
            resp => resp.json()
        ).catch(
            (e)=> console.log(e)
        );

        // logged out user did not give name because the went straight to /session?id=1234 in stead of play/session
        if( userInfo.restricted && localStorage.getItem('session-name') === null ) {

            // display pop up to add username
            let joinPopUp = document.getElementById("join-modal");
            joinPopUp.classList.remove("hide");

            // place the session number inside of the session number input
            let joinInput = document.getElementById("join-input");
            joinInput.value = window.location.href.split("=")[1];
            joinInput.closest('.input-container-items').classList.add('hide');

            // check which input boxes to show depending if user logged in or not
            /*window.addEventListener('load', async () => {

                await displayNameInput();
            });*/
            await displayNameInput();

            document.getElementById('join-button').addEventListener('click', async () => {

                let canJoin = await joinSession();

                if( canJoin ){

                    // remove the modal pop up
                    joinPopUp.classList.add("hide");

                    let clientHandler = new ClientHandler(window.location.href);

                }


            });


        // USER IS LOGGED IN
        }else if( !userInfo.restricted ){

            localStorage.setItem("session-name", userInfo[0].user_name)
            let clientHandler = new ClientHandler(window.location.href);
            window.addEventListener('beforeunload', clientHandler.closeConnection.bind());

        // USER IS NOT LOGGED IN BUT GAVE A NAME BEFORE GOING TO /session?id=1234
        }else{

            let clientHandler = new ClientHandler(window.location.href);
            window.addEventListener('beforeunload', clientHandler.closeConnection.bind());

        }


    </script>


</head>
<body>

<!--  NAV BAR  -->
<nav id="navbar">

    <div id="menu-container">
        <!--        <input id="toggle-button"  class="day" type="button" >-->
    </div>

    <div id="navbar-container" class="hide">
        <ul id="nav-menu">
            <li class="nav-items skeleton skeleton-body-text" onclick="window.location ='/'">Home</li>
            <li class="nav-items skeleton skeleton-body-text" onclick="window.location ='/register'">Sign Up</li>
            <li class="nav-items skeleton skeleton-body-text" onclick="window.location ='/login'">Login</li>
            <li class="nav-items skeleton skeleton-body-text" onclick="window.location ='/about'">About</li>
        </ul>
    </div>

</nav>

<!-- USERS  -->
<div id="players-container">

    <label for="touch"><span>Players</span></label>
    <input type="checkbox" id="touch">

    <ol id="slide" class="slide">
<!--        <li><span class="player-name">Player 1</span> <span class="player-score"> 9 / 10</span></li>-->
    </ol>

</div>

<!-- SETTINGS -->
<section id="settings-box" class="session-settings-box settings-box">

    <div class="settings-boxes">

        <!-- DIFFICULTY -->
        <!--    <div class="settings-modes-div" >

                &lt;!&ndash;            <label for="touch">&ndash;&gt;
                <span class="settings-box-title">
                        <span class="settings-mode">Difficulty</span>
                        <span id="settings-difficulty">
                            <span>Easy | 3 Hints</span>
                            <span>
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-regular fa-star"></i>
                                <i class="fa-regular fa-star"></i>
                            </span>
                        </span>
                    </span>
                &lt;!&ndash;            </label>&ndash;&gt;
                <input type="checkbox" >&lt;!&ndash;id="touch"&ndash;&gt;

                <ul id="difficulty-ul" class="slide">
                    <li value="0" onclick="changeText(this)">
                        <span>Easy | 3 Hints</span>
                        <div>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-regular fa-star"></i>
                            <i class="fa-regular fa-star"></i>
                        </div>
                    </li>
                    <li value="1" onclick="changeText(this)">
                        <span>Medium | 2 Hints</span>
                        <div>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-regular fa-star"></i>
                        </div>
                    </li>
                    <li value="2" onclick="changeText(this)">
                        <span>Hard | 1 Hint</span>
                        <div>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                        </div>
                    </li>
                </ul>
            </div>-->

        <!-- GAME MODE -->
        <div class="settings-modes-div">

            <!--            <label for="touch">-->
            <span class="settings-box-title">
                <span class="settings-mode">Game Mode</span>
                <span id="settings-game-mode">
                     <span>Hints</span>
                    <i title="guess the country with limited hints" class="fa-solid fa-magnifying-glass"></i>
                </span>
            </span>
            <!--            </label>-->
            <input type="checkbox" ><!--id="touch"-->

            <ul id="game-modes-ul" class="slide">
                <li onclick="changeText(this)" class="selected-mode">
                    <span>Hints</span>
                    <i title="guess the country with limited hints" class="fa-solid fa-magnifying-glass"></i>
                    <span class="hide settings-info">Find Waldo with limited facts about the country</span>
                </li>
                <li onclick="changeText(this)" >
                    <span>Flags</span>
                    <i class="fa-solid fa-flag"></i>
                    <span class="hide settings-info">Find Waldo with the country's flag</span>
                </li>
                <li onclick="changeText(this)" >
                    <span>Countries</span>
                    <i class="fa-solid fa-earth-americas"></i>
                    <span class="hide settings-info">Find Waldo with his given location</span>
                </li>
                <li onclick="changeText(this)" >
                    <span>Capitals</span>
                    <i class="fa-solid fa-building-columns"></i>
                    <span class="hide settings-info">Find Waldo with the country's given capital</span>
                </li>
            </ul>
        </div>

        <!-- EXTRA GAME MODE -->
        <div class="settings-modes-div">

            <!--            <label for="touch">-->
            <span class="settings-box-title">
                <span class="settings-mode">Extra Game Mode</span>
                <span id="settings-extra-game-mode">
                    <span>Regular</span>
                    <i class="fa-solid fa-earth-europe"></i>
                </span>
        </span>
            <!--            </label>-->
            <input type="checkbox" ><!--id="touch"-->

            <ul id="extra-game-modes-ul" class="slide">
                <li onclick="changeText(this)" class="selected-mode">
                    <span>Regular</span>
                    <i class="fa-solid fa-earth-europe"></i>
                    <span class="hide settings-info">Waldo's previous location(s) stays on the globe after finding him</span>
                    <!--                <span class="hide settings-info">Find Waldo with the country's given capital</span>-->
                </li>
                <li onclick="changeText(this)">
                    <span>Elimination</span>
                    <i class="fa-solid fa-circle-xmark"></i>
                    <span class="hide settings-info">Waldo's previous location(s) is removed from the globe after finding him</span>
                </li>
            </ul>
        </div>

        <!-- CUSTOM COUNTRIES -->
        <div class="settings-modes-div">

            <!--            <label for="touch">-->
            <span class="settings-box-title">
                <span class="settings-mode">Custom</span>
                <span id="settings-country-options">
                    <span>Countries</span>
                    <i class="fa-solid fa-earth-europe"></i>
                </span>
        </span>
            <!--            </label>-->
            <input type="checkbox" ><!--id="touch"-->


            <ul id="country-options-ul" class="slide">

                <!-- SELECT ALL OPTION-->
                <li id="select-all-country-li">
                    <p>Select All</p>
                    <div class="item">
                        <div class="toggle-pill-color">
                            <input type="checkbox" id="select-all-country-checkbox" name="check" onclick="selectAllCountries()">
                            <label for="select-all-country-checkbox"></label>
                        </div>
                    </div>
                </li>
                <!-- SEARCH OPTION-->
                <li>
                    <input id="search-box" type="text" placeholder="Search Country" oninput="search(this)">
                </li>

            </ul>

        </div>
        <div class="settings-modes-div">

            <div id="country-count-settings-box-title" class="settings-box-title">
                <span class="settings-mode">Country Count</span>

                <!-- COUNTRY COUNT INPUT -->
                <div class="country-count-container" >
                    <p>Country Count</p>
                    <input size="1" maxlength="3" id="country-count" type="text" value="0" >
                    <span id="country-count-message"></span>
                </div>

                <!-- ADD ONLY SELECTED COUNTRIES -->
                <div class="country-count-container">
                    <p>Add Only Selected Countries To Globe</p>
                    <div class="item">
                        <div id="add-selected-country-color" class="toggle-pill-color">
                            <input type="checkbox" id="add-selected-country-checkbox" name="check">
                            <label id="add-selected-country-label" for="add-selected-country-checkbox"></label>
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </div>


    <div class="play-button-div">

        <input id="start-button" class="start-button btn hide" type="button" value="Find Waldo">
        <input id="create-session-button" class="btn hide" type="button" onclick="playWithFriends()" value="Play With Friends">
    </div>

</section>




<!-- HINTS -->
<div id="hints-container" class="hints-container hide no-pointer-event" >

    <div id="hints-header" class="no-pointer-event">

        <div id="title-buttons-div" class="no-pointer-event">


            <h2 id="location-title-h2">
                Find Waldo
            </h2>

            <div id="previous-next-button">
                <input id="previous-button" class="btn previous-button visibilityHidden" type="button" value="Previous"  />
                <input id="next-button" class="btn next-button" type="button" value="Next"  />
                <input id="end-button" class="end-button" type="button" value="End"  onclick="window.location.reload()" />
            </div>

        </div>


        <div id="show-hints-answer-container">

            <div id="show-hints" class="no-pointer-event">

                <input id="get-hint-button" class="btn" type="button" value="Get Hint">
                <input id="next-round-button" class="btn hide" type="button" value="">

                <div id="remaining-div">
                    <div class="" id="remaining-hints-div">Hints Remaining : <span id="remaining-hints-count"></span></div>
                    <div id="remaining-countries-div">Countries Remaining : <span id="remaining-countries-count"></span> </div>
                </div>

            </div>

            <div id="attempt-div">
                <div id="show-answer" class="hide blink-text"> Rotate the globe to find the country </div>
                <div id="show-found-attempt-div" class="show-found-attempt-div">
                    <span id="found-span" > <i class="fa-solid fa-user-secret"></i> : <span id="found-count"></span> </span>
                    <span id="attempt-span">Attempt : <span id="attempt-count"></span> </span>
                </div>
            </div>

        </div>


    </div>


    <div id="hints-div" class="hints-div"> </div>

</div>

<!-- WINNER SCREEN -->
<div id="winner-container" class="hideVisibility" >

    <h1 id="winner-text"><span id="winner"></span> Found Waldo in All Locations</h1>
    <input class="session-end-button btn" type="button" value="End Session" onclick="window.location.href='/play'">
</div>

<!-- WAITING SCREEN FOR USERS -->
<div id="session-wait-div" class="session-wait-div" >

    <div id="session-wait-header">
        <h1><span id="users">0</span> / 10</h1>
        <h1 id="session-id-h1" ></h1>

    </div>

    <div class="session-wait-buttons">
        <input id="session-start-button" class="start-button btn" type="button" value="Find Waldo">
        <input class="session-end-button btn" type="button" value="End Session" onclick="window.location.href='/play'">
    </div>

</div>

<!-- LOADING SCREEN -->
<div id="loader-container" class="loader-container">
    <div id="loader" class="loader"></div>
</div>


<!-- JOIN POP UP IF USER DID NOT GO THROUGH /play/session -->
<form id="join-modal" class="join-container hide">

    <div class="join-items">

        <div class="join-items-header">
            <h1 class="header-title">Join  <span id="session-id"></span></h1>
        </div>

        <div class="input-container">

            <div class="input-container-items" >

                <div class="icon-container">
                    <i class="fa-solid fa-user"></i>
                </div>

                <input id="join-input" class="join-input" type="text" placeholder="Session Number" />

                <div class="issue-container">
                    <i class="fa-solid fa-exclamation-circle hideVisibility"></i>
                    <span class="issue-message hideVisibility"></span>
                </div>

            </div>

            <div class="input-container-items" >

                <div class="icon-container">
                    <i class="fa-solid fa-user"></i>
                </div>

                <input id="name-input" class="join-input" type="text" placeholder="User Name" />

                <div class="issue-container">
                    <i class="fa-solid fa-exclamation-circle hideVisibility"></i>
                    <span class="issue-message hideVisibility"></span>
                </div>

            </div>

            <input id="join-button" type="button" class="join-button" value="Join">

        </div>

    </div>

</form>

<script type="text/javascript" src="/js/playSettings.js"></script>

<script type="text/javascript">

    let sessionIDFromURL = window.location.href.split("=")[1];

    document.getElementById("session-id").innerText = sessionIDFromURL;
    document.getElementById("session-id-h1").innerText = sessionIDFromURL;


</script>

</body>
</html>